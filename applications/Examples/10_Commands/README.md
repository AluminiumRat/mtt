# Кратко
Применяем команды и стек команд.

# Детально
Стек команд используется в mtt для обеспечения undo/redo функционала.

Суть технологии в том, что редактирование объектной модели происходит не напрямую, а с помощью специальных объектов - команд (см. паттерн Command). В mtt - это классы, унаследованные от mtt::AbstractEditCommand. Команды могут как изменять данные(метод AbstractEditCommand::make), так и откатывать изменения(AbstractEditCommand::undo).

После того как команда выполнена, она добавляется в стек команд(класс mtt::UndoStack), и вызов AbstractEditCommand::undo для выполненных команд возможен только в порядке, обратном порядку их выполнения.

В этом примере мы создадим с помощью команд простую композицию объектов и используем стек, для того чтобы откатывать и повторять процесс её создания.

## ObjectWithValue
Для демонстрации команды mtt::SetValueCommand нам потребуется класс ObjectWithValue. Это простой объект, который хранит в себе некоторое значение, а также имеет геттер и сеттер. В сеттере мы производим запись в лог, для того чтобы видеть, что значение изменилось.

## Создаем объекты и заполняем стек
Создание объектов и заполнение сцены происходит в функции buildObjcts.

Мы используем команды mtt::AddObjectCommand, для того чтобы добавить объекты "Group" и "Child" в корневой объект, и команду mtt::MoveObjectCommand, для того чтобы переместить объект "Child" из root в "Group". В принципе, можно было бы обойтись и без MoveObjectCommand, для этого надо было добавлять "Child" в "Group".

Наконец, мы меняем значение в объекте "Child" с помощью команды mtt::SetPropertyCommand. Список шаблонных аргументов может ужаснуть, но на самом деле там всё просто: первый аргумент - тип объекта, который содержит значение; второй аргумент - тип самого значения; третий - тип геттера(у нас это - указатель на метод класса ObjectWithValue); четвертый - тип сеттера(тоже указатель на метод).

Обратите внимание, что выполнение команд и добавление их в стек производится одним методом UndoStack::addAndMake, а не двумя раздельными. Дело в том, что в команда не обязана вернуть данные в исходный вид, если во время её выполнения произошло исключение. Так как мы не можем знать, в каком именно состоянии находятся данные, то стек теряет свой смысл и должен быть сброшен. Именно этой рутиной и занимается метод addAndMake:

    void UndoStack::addAndMake(std::unique_ptr<AbstractEditCommand> command)
    {
      try
      {
        command->make();
        addCommand(std::move(command));
      }
      catch(...)
      {
        clear();
        throw;
      }
    }

## Окно управления
Окно управления заполняется в функции fillWindow.

Мы добавляем QTreeView для визуализации структуры наших объектов. Этот прием был уже описан ранее в примере 08_Objects. Также мы добавляем кнопки Undo и Redo для управления стеком команд.